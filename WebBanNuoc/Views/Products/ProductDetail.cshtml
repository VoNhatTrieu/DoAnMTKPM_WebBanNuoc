@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var productId = ViewBag.ProductId;
}

<div class="container py-5" id="productDetailContainer">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
        <p class="mt-2 text-muted">Đang tải thông tin sản phẩm...</p>
    </div>
</div>

<style>
.topping-item:has(.form-check-input:checked) {
    background-color: #FFF5F0 !important;
    border-color: #FF6B35 !important;
}
</style>

@section scripts {
<script>
const PRODUCTS_API_BASE = 'http://localhost:5299/api';
const productId = @productId;
let currentProduct = null;
let quantity = 1;
const noImageSvg = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23f0f0f0" width="400" height="300"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="20"%3ENo Image%3C/text%3E%3C/svg%3E';

async function loadProductDetail() {
    try {
        const response = await fetch(`${PRODUCTS_API_BASE}/products/${productId}`);
        if (!response.ok) throw new Error('Product not found');
        const result = await response.json();
        if (result.success && result.data) {
            currentProduct = result.data;
            renderProductDetail(result.data);
        }
    } catch (error) {
        $('#productDetailContainer').html('<div class="alert alert-danger">Không thể tải sản phẩm</div>');
    }
}

function renderProductDetail(p) {
    const img = p.imageUrl || noImageSvg;
    $('#productDetailContainer').html(`
<nav aria-label="breadcrumb"><ol class="breadcrumb">
<li class="breadcrumb-item"><a href="/Home">Trang chủ</a></li>
<li class="breadcrumb-item"><a href="/Products">Sản phẩm</a></li>
<li class="breadcrumb-item active">${esc(p.name)}</li>
</ol></nav>
<div class="row g-5">
<div class="col-lg-5">
<div class="text-center p-4 bg-light rounded-4">
<img id="mainImg" src="${img}" alt="${esc(p.name)}" class="img-fluid rounded" style="max-height:400px;object-fit:contain" onerror="this.src='${noImageSvg}'">
</div>
</div>
<div class="col-lg-7">
<h1 class="fw-bold mb-3">${esc(p.name)}</h1>
<span class="badge ${p.isAvailable?'bg-success':'bg-danger'} mb-3">${p.isAvailable?'Còn hàng':'Hết hàng'}</span>
<p class="text-muted">${esc(p.description||'Đồ uống ngon')}</p>

<div class="mb-4"><label class="fw-bold mb-2">Size</label>
<div class="btn-group w-100">
<input type="radio" class="btn-check" name="size" id="s-s" value="S" data-price="0">
<label class="btn btn-outline-primary" for="s-s">S +0₫</label>
<input type="radio" class="btn-check" name="size" id="s-m" value="M" data-price="5000" checked>
<label class="btn btn-outline-primary" for="s-m">M +5k₫</label>
<input type="radio" class="btn-check" name="size" id="s-l" value="L" data-price="10000">
<label class="btn btn-outline-primary" for="s-l">L +10k₫</label>
</div></div>

<div class="mb-4"><label class="fw-bold mb-2">Đường</label>
<div class="btn-group w-100">
<input type="radio" class="btn-check" name="sugar" id="sg-0" value="0%">
<label class="btn btn-outline-warning" for="sg-0">0%</label>
<input type="radio" class="btn-check" name="sugar" id="sg-50" value="50%">
<label class="btn btn-outline-warning" for="sg-50">50%</label>
<input type="radio" class="btn-check" name="sugar" id="sg-100" value="100%" checked>
<label class="btn btn-outline-warning" for="sg-100">100%</label>
</div></div>

<div class="mb-4"><label class="fw-bold mb-2">Đá</label>
<div class="btn-group w-100">
<input type="radio" class="btn-check" name="ice" id="i-0" value="Không">
<label class="btn btn-outline-info" for="i-0">Không</label>
<input type="radio" class="btn-check" name="ice" id="i-1" value="Ít">
<label class="btn btn-outline-info" for="i-1">Ít</label>
<input type="radio" class="btn-check" name="ice" id="i-2" value="Nhiều" checked>
<label class="btn btn-outline-info" for="i-2">Nhiều</label>
</div></div>

<div class="mb-4" id="toppings"></div>

<div class="row mb-4">
<div class="col-6">
<label class="fw-bold mb-2">Số lượng</label>
<div class="input-group">
<button class="btn btn-outline-secondary" id="dec">-</button>
<input type="text" class="form-control text-center" id="qty" value="1" readonly>
<button class="btn btn-outline-secondary" id="inc">+</button>
</div>
</div>
<div class="col-6">
<label class="fw-bold mb-2">Tổng</label>
<h3 class="text-primary fw-bold" id="total">${formatCurrency(p.basePrice)}</h3>
</div>
</div>

<button class="btn btn-primary btn-lg w-100" id="addCart" ${!p.isAvailable?'disabled':''}>
<i class="fas fa-cart-plus me-2"></i>${p.isAvailable?'Thêm vào giỏ':'Hết hàng'}
</button>
</div>
</div>
    `);
    loadToppings();
    initEvents(p);
}

async function loadToppings() {
    try {
        const res = await fetch(`${PRODUCTS_API_BASE}/products/toppings`);
        const r = await res.json();
        if (r.success && r.data) {
            let h = '<label class="fw-bold mb-2">Topping</label>';
            r.data.filter(t => t.isAvailable).forEach(t => {
                h += `<div class="form-check mb-2 topping-item p-2 rounded">
<input class="form-check-input tpchk" type="checkbox" id="t${t.id}" data-price="${t.price}">
<label class="form-check-label d-flex justify-content-between w-100" for="t${t.id}">
<span>${esc(t.name)}</span><span class="text-primary">+${formatCurrency(t.price)}</span>
</label></div>`;
            });
            $('#toppings').html(h);
            $('.tpchk').on('change', calcPrice);
        }
    } catch (e) {}
}

function initEvents(p) {
    $('input[name="size"],input[name="sugar"],input[name="ice"]').on('change', calcPrice);
    $('#inc').click(() => { quantity++; $('#qty').val(quantity); calcPrice(); });
    $('#dec').click(() => { if(quantity>1) { quantity--; $('#qty').val(quantity); calcPrice(); } });
    $('#addCart').click(() => addCart(p));
    calcPrice();
}

function calcPrice() {
    if (!currentProduct) return;
    let t = currentProduct.basePrice;
    t += parseInt($('input[name="size"]:checked').data('price') || 0);
    $('.tpchk:checked').each(function() { t += parseInt($(this).data('price') || 0); });
    t *= quantity;
    $('#total').text(formatCurrency(t));
}

function addCart(p) {
    const item = {
        id: p.id,
        name: p.name,
        image: p.imageUrl || noImageSvg,
        price: parseInt($('#total').text().replace(/[^\d]/g, '')) / quantity,
        quantity: quantity,
        size: $('input[name="size"]:checked').val(),
        sugar: $('input[name="sugar"]:checked').val(),
        ice: $('input[name="ice"]:checked').val(),
        toppings: $('.tpchk:checked').map(function() { return $(this).next().find('span').first().text(); }).get().join(', ')
    };
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const idx = cart.findIndex(i => i.id === item.id && i.size === item.size && i.sugar === item.sugar && i.ice === item.ice && i.toppings === item.toppings);
    if (idx > -1) cart[idx].quantity += item.quantity;
    else cart.push(item);
    
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    alert('Đã thêm vào giỏ hàng!');
}

function formatCurrency(n) {
    return new Intl.NumberFormat('vi-VN', {style:'currency',currency:'VND'}).format(n);
}

function esc(t) {
    if (!t) return '';
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

$(document).ready(() => loadProductDetail());
</script>
}
